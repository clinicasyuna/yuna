rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Funções utilitárias =====
    function isSignedIn() {
      return request.auth != null;
    }

    function adminDoc() {
      return get(/databases/$(database)/documents/usuarios_admin/$(request.auth.uid));
    }

    function equipeDoc() {
      return get(/databases/$(database)/documents/usuarios_equipe/$(request.auth.uid));
    }

    function acompanhanteDoc() {
      return get(/databases/$(database)/documents/usuarios_acompanhantes/$(request.auth.uid));
    }

    function isActive(doc) {
      return doc.exists && doc.data.ativo == true;
    }

    function isSuperAdmin() {
      return isSignedIn() && isActive(adminDoc()) && adminDoc().data.role == 'super_admin';
    }

    function isAdmin() {
      return isSignedIn() && isActive(adminDoc()) &&
             (adminDoc().data.role == 'admin' || adminDoc().data.role == 'super_admin');
    }

    function isEquipe() {
      return isSignedIn() && isActive(equipeDoc());
    }

    function userEquipe() {
      return isEquipe() ? (equipeDoc().data.equipe != null ? equipeDoc().data.equipe : equipeDoc().data.departamento) : null;
    }

    function isAcompanhante() {
      return isSignedIn() && isActive(acompanhanteDoc());
    }

    function isOwner(uidField) {
      return isSignedIn() && uidField == request.auth.uid;
    }

    // ===== Usuários administradores =====
    match /usuarios_admin/{userId} {
      allow read: if isAdmin();
      allow create, update, delete: if isSuperAdmin();
    }

    // ===== Usuários de equipe =====
    match /usuarios_equipe/{userId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow create, update: if isSuperAdmin() || isAdmin();
      allow delete: if isSuperAdmin();
    }

    // ===== Usuários acompanhantes =====
    match /usuarios_acompanhantes/{userId} {
      allow read: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow create: if isSignedIn() && request.auth.uid == userId; // auto-cadastro
      allow update: if isAdmin() || (isSignedIn() && request.auth.uid == userId);
      allow delete: if isSuperAdmin();
    }

    // ===== Solicitações =====
    match /solicitacoes/{solicitacaoId} {
      function solicitacaoEquipe() {
        return resource.exists ? resource.data.equipe : request.resource.data.equipe;
      }

      function solicitacaoUsuario() {
        return resource.exists ? resource.data.usuarioId : request.resource.data.usuarioId;
      }

      allow read: if isAdmin()
        || (isEquipe() && solicitacaoEquipe() == userEquipe())
        || (isAcompanhante() && solicitacaoUsuario() == request.auth.uid);

      allow create: if isAdmin()
        || (isEquipe() && request.resource.data.equipe == userEquipe())
        || (isAcompanhante() && request.resource.data.usuarioId == request.auth.uid);

      allow update: if isAdmin()
        || (isEquipe() && solicitacaoEquipe() == userEquipe())
        || (
          isAcompanhante()
          && solicitacaoUsuario() == request.auth.uid
          && request.resource.data.usuarioId == request.auth.uid
          && request.resource.data.equipe == resource.data.equipe
          && request.resource.data.status == resource.data.status
        );

      allow delete: if isSuperAdmin();
    }

    // ===== Avaliações de satisfação =====
    match /avaliacoes_satisfacao/{avaliacaoId} {
      allow read: if isAdmin() || (isAcompanhante() && resource.data.usuarioId == request.auth.uid);
      allow create: if isAdmin() || (isAcompanhante() && request.resource.data.usuarioId == request.auth.uid);
      allow update: if isAdmin() || (isAcompanhante() && resource.data.usuarioId == request.auth.uid);
      allow delete: if isSuperAdmin();
    }

    // ===== Quartos ocupados =====
    match /quartos_ocupados/{quartoId} {
      allow read: if isAdmin() || isEquipe() || (isAcompanhante() && resource.data.acompanhanteId == request.auth.uid);

      allow create: if isAdmin()
        || isEquipe()
        || (isAcompanhante() && request.resource.data.acompanhanteId == request.auth.uid);

      allow update: if isAdmin()
        || isEquipe()
        || (isAcompanhante() && resource.data.acompanhanteId == request.auth.uid && request.resource.data.acompanhanteId == request.auth.uid);

      allow delete: if isSuperAdmin();
    }

    // ===== Logs de auditoria =====
    match /logs_auditoria/{logId} {
      allow read: if isAdmin();
      allow create: if isSignedIn() &&
        (
          !('usuarioId' in request.resource.data) ||
          request.resource.data.usuarioId == request.auth.uid ||
          request.resource.data.usuarioId == 'anonimo'
        );
      allow update, delete: if false; // imutável
    }

    // ===== NOVO: Sistema de Auditoria v2.0 =====
    
    // Logs de auditoria - apenas admins podem ler, todos autenticados podem escrever
    match /audit_logs/{logId} {
      allow read: if isAdmin(); // Apenas admins leem
      allow create: if isSignedIn(); // Qualquer usuário autenticado pode criar log de suas ações
      allow update, delete: if false; // Logs são imutáveis
    }
    
    // Usuários online - controle de presença
    match /usuarios_online/{userId} {
      allow read: if isAdmin(); // Apenas admins veem quem está online
      allow write: if isSignedIn() && userId == request.auth.uid; // Usuário só atualiza próprio status
      allow delete: if isSignedIn() && userId == request.auth.uid; // Usuário só remove próprio status
    }
  }
}